{% extends "layout.html" %}
{% block title %}Tableau de bord ‚Äì Pointage{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üìä Tableau de bord ‚Äì Pointage</h2>

  <!-- ‚úÖ Formulaire d'exportation -->
  <h4 class="mt-5">Exporter les pointages</h4>
  <form method="POST" action="{{ url_for('export_records') }}" class="row g-3">

    <!-- Type d‚Äôexport -->
    <div class="col-md-3">
      <label for="export_type" class="form-label">Type d‚Äôexportation</label>
      <select name="export_type" id="export_type" class="form-select" onchange="toggleMonthInput()">
        <option value="all">Tous les pointages</option>
        <option value="month">Un mois sp√©cifique</option>
      </select>
    </div>

    <!-- S√©lection du mois -->
    <div class="col-md-3" id="month_container" style="display:none;">
      <label for="mois" class="form-label">Choisir un mois</label>
      <select name="mois" id="mois" class="form-select">
        <option value="">-- S√©lectionner --</option>
        {% for m in range(1,13) %}
        <option value="{{ m }}">{{ ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"][m-1] }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Filtre par service -->
    <div class="col-md-3">
      <label for="service" class="form-label">Service (optionnel)</label>
      <select name="service" id="service" class="form-select">
        <option value="">-- Tous les services --</option>
        {% for s in services %}
        <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Filtre par employ√© -->
    <div class="col-md-3">
      <label for="employe" class="form-label">Employ√© (optionnel)</label>
      <select name="employe" id="employe" class="form-select">
        <option value="">-- Tous les employ√©s --</option>
        {% for e in employes %}
        <option value="{{ e.id }}">{{ e.prenom }} {{ e.nom }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Format d'export -->
    <div class="col-md-3">
      <label for="format" class="form-label">Format</label>
      <select name="format" id="format" class="form-select" required>
        <option value="excel">Excel</option>
        <option value="pdf">PDF</option>
      </select>
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-success w-100">Exporter</button>
    </div>
  </form>


  <!-- ‚úÖ Formulaire de recherche combin√©e -->
  <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 mb-4 mt-5">
    <!-- Filtre par date -->
    <div class="col-md-2">
      <input type="date" name="date" class="form-control"
            value="{{ request.args.get('date','') }}">
    </div>

    <!-- Filtre par service -->
    <div class="col-md-3">
      <select name="service" class="form-select">
        <option value="">-- Tous les services --</option>
        {% for s in services %}
        <option value="{{ s }}" {% if request.args.get('service') == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Filtre par statut -->
    <div class="col-md-3">
      <select name="statut" class="form-select">
        <option value="">-- Tous les statuts --</option>
        <option value="a_l_heure" {% if request.args.get('statut') == "a_l_heure" %}selected{% endif %}>√Ä l'heure</option>
        <option value="retard" {% if request.args.get('statut') == "retard" %}selected{% endif %}>En retard</option>
        <option value="absent" {% if request.args.get('statut') == "absent" %}selected{% endif %}>Absent</option>
      </select>
    </div>

    <!-- Boutons -->
    <div class="col-md-3">
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Aujourd'hui</a>
      <button type="submit" class="btn btn-primary w-70">üîç Rechercher</button>
    </div>
  </form>



  <!-- ‚úÖ Classement -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>Pr√©nom</th>
          <th>Nom</th>
          <th>Service</th>
          <th>Date</th>
          <th>Heure d'arriv√©e</th>
          <th>Heure de sortie</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        {% if utilisateurs %}
          {% for u in utilisateurs %}
          <tr>
            <td>{{ u.prenom }}</td>
            <td>{{ u.nom }}</td>
            <td>{{ u.service }}</td>
            <td>{{ u.date_pointage or '-' }}</td>
            <td>{{ u.heure_arrivee or '-' }}</td>
            <td>{{ u.heure_sortie or '-' }}</td>
            <td>
              {% if u.statut == "a_l_heure" %}
                <span class="badge bg-success">√Ä l'heure</span>
              {% elif u.statut == "retard" %}
                <span class="badge bg-warning text-dark">Retard</span>
              {% elif u.statut == "absent" %}
                <span class="badge bg-danger">Absent</span>
              {% else %}
                <span class="badge bg-secondary">-</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center text-muted">Aucun pointage trouv√©</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- ‚úÖ Derniers pointages temps r√©el -->
  <h4 class="mt-5">Derniers pointages (temps r√©el)</h4>
  <ul id="liste-pointages" class="list-group"></ul>
</div>

<!-- ‚úÖ Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  var socket = io();

  socket.on("nouveau_pointage", function(data) {
    let ul = document.getElementById("liste-pointages");
    let li = document.createElement("li");
    li.classList.add("list-group-item");

    let dateStr = data.date_pointage;
    if (data.heure_arrivee) {
      dateStr += " √† " + data.heure_arrivee;
    }

    let nomAffiche = "";
    if (data.prenom && data.nom) {
      nomAffiche = `${data.prenom} ${data.nom} (${data.service || "N/A"})`;
    } else {
      nomAffiche = "Utilisateur #" + data.id_utilisateur;
    }

    li.innerHTML = `<strong>${nomAffiche}</strong> a point√© <em>${dateStr}</em>`;
    ul.prepend(li);

    // ‚úÖ Limiter √† 20 derniers
    if (ul.children.length > 20) {
      ul.removeChild(ul.lastChild);
    }
  });

  // ‚úÖ Afficher/cacher le choix du mois
  function toggleMonthInput() {
    let type = document.getElementById("export_type").value;
    document.getElementById("month_container").style.display = (type === "month") ? "block" : "none";
  }
</script>
{% endblock %}
