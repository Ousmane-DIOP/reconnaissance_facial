{% extends "layout.html" %}
{% block title %}Tableau de bord - Pointage{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üìä Tableau de bord - Pointage</h2>

  <!-- üïì Date actuelle -->
  <div class="alert alert-info py-2">
    <strong>Date actuelle :</strong> {{ date_pointage }}
  </div>

  <!-- ‚úÖ FORMULAIRE DE RECHERCHE / FILTRES -->
  <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 mb-4">
    <!-- Filtre par date -->
    <div class="col-md-2">
      <label class="form-label">Date</label>
      <input type="date" name="date" class="form-control"
             value="{{ filtres.date or '' }}">
    </div>

    <!-- Filtre par service -->
    <div class="col-md-3">
      <label class="form-label">Service</label>
      <select name="service" class="form-select">
        <option value="">-- Tous les services --</option>
        {% for s in services %}
          <option value="{{ s }}" {% if filtres.service == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Filtre par statut -->
    <div class="col-md-3">
      <label class="form-label">Statut</label>
      <select name="statut" class="form-select">
        <option value="">-- Tous les statuts --</option>
        <option value="a_l_heure" {% if filtres.statut == "a_l_heure" %}selected{% endif %}>√Ä l'heure</option>
        <option value="retard" {% if filtres.statut == "retard" %}selected{% endif %}>En retard</option>
        <option value="absent" {% if filtres.statut == "absent" %}selected{% endif %}>Absent</option>
      </select>
    </div>

    <!-- Boutons -->
    <div class="col-md-4 d-flex align-items-end gap-2">
      <button type="submit" class="btn btn-primary w-50">üîç Rechercher</button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary w-50">üìÖ Aujourd‚Äôhui</a>
    </div>
  </form>

  <hr class="my-4">

  <!-- ‚úÖ FORMULAIRE D'EXPORTATION -->
  <h4 class="mb-3">üì§ Exporter les pointages</h4>
  <form method="POST" action="{{ url_for('export_records') }}" class="row g-3 mb-5">
    <!-- Type d‚Äôexport -->
    <div class="col-md-3">
      <label for="export_type" class="form-label">Type d‚Äôexportation</label>
      <select name="export_type" id="export_type" class="form-select" onchange="toggleMonthInput()">
        <option value="all">Tous les pointages</option>
        <option value="month">Un mois sp√©cifique</option>
      </select>
    </div>

    <!-- S√©lection du mois -->
    <div class="col-md-3" id="month_container" style="display:none;">
      <label for="mois" class="form-label">Mois</label>
      <select name="mois" id="mois" class="form-select">
        <option value="">-- S√©lectionner --</option>
        {% for m in range(1,13) %}
          <option value="{{ m }}">{{ ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"][m-1] }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Service -->
    <div class="col-md-3">
      <label for="service" class="form-label">Service (optionnel)</label>
      <select name="service" id="service" class="form-select">
        <option value="">-- Tous les services --</option>
        {% for s in services %}
          <option value="{{ s }}" {% if filtres.service == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Employ√© -->
    <div class="col-md-3">
      <label for="employe" class="form-label">Employ√© (optionnel)</label>
      <select name="employe" id="employe" class="form-select">
        <option value="">-- Tous les employ√©s --</option>
        {% for e in employes %}
          <option value="{{ e.id }}">{{ e.prenom }} {{ e.nom }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Format -->
    <div class="col-md-3">
      <label for="format" class="form-label">Format</label>
      <select name="format" id="format" class="form-select" required>
        <option value="excel">Excel (.xlsx)</option>
        <option value="pdf">PDF (.pdf)</option>
      </select>
    </div>

    <!-- Bouton -->
    <div class="col-12">
      <button type="submit" class="btn btn-success w-100">üíæ Exporter</button>
    </div>
  </form>

  <!-- ‚úÖ TABLEAU DES POINTAGES -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>Pr√©nom</th>
          <th>Nom</th>
          <th>Service</th>
          <th>Date</th>
          <th>Heure d'arriv√©e</th>
          <th>Heure de sortie</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        {% if utilisateurs %}
          {% for u in utilisateurs %}
            <tr>
              <td>{{ u.prenom }}</td>
              <td>{{ u.nom }}</td>
              <td>{{ u.service }}</td>
              <td>{{ u.date_pointage or '-' }}</td>
              <td>{{ u.heure_arrivee or '-' }}</td>
              <td>{{ u.heure_sortie or '-' }}</td>
              <td>
                {% if u.statut == "a_l_heure" %}
                  <span class="badge bg-success">√Ä l'heure</span>
                {% elif u.statut == "retard" %}
                  <span class="badge bg-warning text-dark">Retard</span>
                {% elif u.statut == "absent" %}
                  <span class="badge bg-danger">Absent</span>
                {% else %}
                  <span class="badge bg-secondary">-</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">Aucun pointage trouv√©</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- ‚úÖ Derniers pointages temps r√©el -->
  <h4 class="mt-5">üïí Derniers pointages (temps r√©el)</h4>
  <ul id="liste-pointages" class="list-group"></ul>
</div>

<!-- ‚úÖ Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();

  socket.on("nouveau_pointage", function(data) {
    let ul = document.getElementById("liste-pointages");
    let li = document.createElement("li");
    li.classList.add("list-group-item");

    let dateStr = data.date_pointage;
    if (data.heure_arrivee) {
      dateStr += " √† " + data.heure_arrivee;
    }

    let nomAffiche = data.prenom && data.nom
      ? `${data.prenom} ${data.nom} (${data.service || "N/A"})`
      : "Utilisateur #" + data.id_utilisateur;

    li.innerHTML = `<strong>${nomAffiche}</strong> a point√© <em>${dateStr}</em>`;
    ul.prepend(li);

    if (ul.children.length > 20) {
      ul.removeChild(ul.lastChild);
    }
  });

  // ‚úÖ Afficher/cacher la s√©lection de mois
  function toggleMonthInput() {
    const type = document.getElementById("export_type").value;
    document.getElementById("month_container").style.display = (type === "month") ? "block" : "none";
  }
</script>
{% endblock %}